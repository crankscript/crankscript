name: CI

on:
    pull_request:

permissions:
    contents: read

jobs:
    main:
        name: Test packages
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node
              uses: pnpm/action-setup@v4

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Lint all packages
              run: pnpm lint

            - name: Build all packages
              run: pnpm build

            - name: Test all packages
              run: pnpm test

    lua-runtime-tests:
        name: Lua runtime tests
        runs-on: ubuntu-latest
        container: node:20
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node
              uses: pnpm/action-setup@v4

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build tstl-plugin and move to CLI
              run: pnpm --filter @crankscript/tstl-library build-dev

            - name: Install headless dependencies
              run: apt-get update && apt-get install -y xvfb libgtk-3-0 sudo libwebkit2gtk-4.0 libwebkit2gtk-4.0-dev libsdl2-dev pulseaudio

            - name: Setup audio sink
              run: |
                  export HOME="/config"
                  pulseaudio -D --exit-idle-time=-1
                  pactl load-module module-null-sink sink_name=SpeakerOutput sink_properties=device.description="Dummy_Output"

            - name: Setup Playdate SDK
              run: |
                  wget -q https://download.panic.com/playdate_sdk/Linux/PlaydateSDK-2.7.5.tar.gz
                  tar -xzf PlaydateSDK-2.7.5.tar.gz
                  echo "PLAYDATE_SDK_PATH=$(pwd)/PlaydateSDK-2.7.5" >> $GITHUB_ENV

            - name: Create simulator ini
              run: |
                  export PD_INI_DIR="/config/.config/Playdate Simulator"
                  mkdir -p "$PD_INI_DIR"
                  export PD_INI_FILE="$PD_INI_DIR/Playdate Simulator.ini"
                  echo "ShowPerfWarning=0" > $PD_INI_FILE
                  echo "ShowElist=0" >> $PD_INI_FILE
                  echo "LastRelease=$(cat PlaydateSDK-*/VERSION.txt)" >> $PD_INI_FILE

            - name: Run Lua runtime tests
              run: |
                  export HOME="/config"
                  export PLAYDATE_SDK_PATH=$(pwd)/PlaydateSDK-2.7.5
                  xvfb-run -a pnpm run crankscript-dev test --path playdate-tests
