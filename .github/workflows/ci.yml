name: CI

on:
    pull_request:

permissions:
    contents: read

jobs:
    main:
        name: Test packages
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node
              uses: pnpm/action-setup@v4

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Lint all packages
              run: pnpm lint

            - name: Build all packages
              run: pnpm build

            - name: Test all packages
              run: pnpm test

    lua-runtime-tests:
        name: Lua runtime tests
        runs-on: ubuntu-latest
        container: ubuntu:24.04
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Node.js and pnpm
              run: |
                  apt-get update
                  apt-get install -y curl ca-certificates
                  curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
                  apt-get install -y nodejs
                  npm install -g pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build tstl-plugin and move to CLI
              run: pnpm --filter @crankscript/tstl-library build-dev

            - name: Detect latest Playdate SDK version
              id: detect-version
              run: |
                  # Find all version files in types folder, exclude latest.d.ts
                  VERSION=$(ls libs/types/types/*.d.ts | grep -v latest.d.ts | sed 's|libs/types/types/||' | sed 's|\.d\.ts||' | sort -V | tail -n 1)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Detected latest Playdate SDK version: $VERSION"

            - name: Install headless dependencies
              run: apt-get update && apt-get install -y wget xvfb libgtk-3-0 sudo libwebkit2gtk-4.1 libsdl2-dev pulseaudio

            - name: Setup audio sink
              run: |
                  export HOME="/config"
                  pulseaudio -D --exit-idle-time=-1
                  pactl load-module module-null-sink sink_name=SpeakerOutput sink_properties=device.description="Dummy_Output"

            - name: Setup Playdate SDK
              run: |
                  VERSION="${{ steps.detect-version.outputs.version }}"
                  wget -q "https://download.panic.com/playdate_sdk/Linux/PlaydateSDK-${VERSION}.tar.gz"
                  tar -xzf "PlaydateSDK-${VERSION}.tar.gz"
                  echo "PLAYDATE_SDK_PATH=$(pwd)/PlaydateSDK-${VERSION}" >> $GITHUB_ENV

            - name: Create simulator ini
              run: |
                  export PD_INI_DIR="/config/.config/Playdate Simulator"
                  mkdir -p "$PD_INI_DIR"
                  export PD_INI_FILE="$PD_INI_DIR/Playdate Simulator.ini"
                  echo "ShowPerfWarning=0" > $PD_INI_FILE
                  echo "ShowElist=0" >> $PD_INI_FILE
                  echo "LastRelease=$(cat PlaydateSDK-*/VERSION.txt)" >> $PD_INI_FILE

            - name: Run Lua runtime tests
              run: |
                  VERSION="${{ steps.detect-version.outputs.version }}"
                  export HOME="/config"
                  export PLAYDATE_SDK_PATH=$(pwd)/PlaydateSDK-${VERSION}
                  xvfb-run -a pnpm run crankscript-dev test --path playdate-tests
